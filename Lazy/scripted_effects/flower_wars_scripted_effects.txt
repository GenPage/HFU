flip_flw_initiative = {
	if = {
		limit = {
			check_variable = { GLOBAL.flw_attacker_tag = ATE.id }
			ATE = { NOT = { controls_no_clash_states = yes } }
		}
		set_variable = { GLOBAL.flw_attacker_tag = ITZ.id }
		set_variable = { GLOBAL.flw_defender_tag = ATE.id }
	}
	else_if = {
		limit = {
			check_variable = { GLOBAL.flw_attacker_tag = ITZ.id }
			ITZ = { NOT = { controls_no_clash_states = yes } }
		}
		set_variable = { GLOBAL.flw_attacker_tag = ATE.id }
		set_variable = { GLOBAL.flw_defender_tag = ITZ.id }
	}
	else_if = {
		limit = {
			var:GLOBAL.flw_defender_tag = { controls_no_clash_states = yes }
		}
		# no effect, gets to try again
	}
	else_if = {
		end_flw = yes
		log = "Neither ATE nor ITZ have initiative: trying to flip"
	}
}

end_flw = {
	every_country = {
		limit = { has_idea = flw_the_flower_wars }
		country_event = flw.5
	}
	set_global_flag = flw_ended
}

set_new_flw_target = {
	log = "Start of flip: AT: [?GLOBAL.flw_attacker_tag], DT: [?GLOBAL.flw_defender_tag], AS: [?GLOBAL.flw_attacker_state], DS: [?GLOBAL.flw_defender_state]"
	flip_flw_initiative = yes
	if = {
		limit = { check_variable = { GLOBAL.flw_attacker_tag = ATE.id } }
		if = {
			limit = { 817 = { is_owned_and_controlled_by = ATE } }
			#should not happen!!
			log = "ATE has the initiative despite owning all three states! Tell Happy!"
			hidden_effect = {
				if = {
					limit = { NOT = { has_global_flag = flip_loop } }
					set_global_flag = flip_loop
					set_new_flw_target = yes
				}
				else_if = {
					log = "In a ATE flip loop!"
				}
			}
		}
		else_if = {
			limit = { 815 = { is_owned_and_controlled_by = ATE } }
			set_variable = { GLOBAL.flw_attacker_state = 814 }
			set_variable = { GLOBAL.flw_defender_state = 817 }
		}
		else_if = {
			limit = { 803 = { is_owned_and_controlled_by = ATE } }
			set_variable = { GLOBAL.flw_attacker_state = 803 }
			set_variable = { GLOBAL.flw_defender_state = 815 }
		}
		else_if = {
			limit = { ATE = { controls_no_clash_states = yes } }
			set_variable = { GLOBAL.flw_attacker_state = 810 }
			set_variable = { GLOBAL.flw_defender_state = 803 }
		}
		else_if = {
			log = "ATE failed all checks when having initive."
		}
	}
	else_if = {
		limit = { check_variable = { GLOBAL.flw_attacker_tag = ITZ.id } }
		if = {
			limit = { 803 = { is_owned_and_controlled_by = ITZ } }
			#should not happen!!
			log = "ITZ has the initiative despite owning all three states! Tell Happy!"
			hidden_effect = {
				if = {
					limit = { NOT = { has_global_flag = flip_loop } }
					set_global_flag = flip_loop
					set_new_flw_target = yes
				}
				else_if = {
					log = "In a ITZ flip loop!"
				}
			}
		}
		else_if = {
			limit = { 815 = { is_owned_and_controlled_by = ITZ } }
			set_variable = { GLOBAL.flw_attacker_state = 815 }
			set_variable = { GLOBAL.flw_defender_state = 803 }
		}
		else_if = {
			limit = { 817 = { is_owned_and_controlled_by = ITZ } }
			set_variable = { GLOBAL.flw_attacker_state = 816 }
			set_variable = { GLOBAL.flw_defender_state = 815 }
		}
		else_if = {
			limit = { ITZ = { controls_no_clash_states = yes } }
			set_variable = { GLOBAL.flw_attacker_state = 818 }
			set_variable = { GLOBAL.flw_defender_state = 817 }
		}
		else_if = {
			log = "ITZ failed all checks when having initive."
		}
	}
	else_if = {
		end_flw = yes
		log = "Neither ATE nor ITZ have initiative: trying to set states"
	}
	clr_global_flag = flip_loop
	log = "End of flip: AT: [?GLOBAL.flw_attacker_tag], DT: [?GLOBAL.flw_defender_tag], AS: [?GLOBAL.flw_attacker_state], DS: [?GLOBAL.flw_defender_state]"
}

fire_clash = {
	var:GLOBAL.flw_attacker_tag = {
		if = {
			limit = {
				tag = ATE
			}
			start_border_war = {
				change_state_after_war = no # handled via event
				attacker = {
					state = var:GLOBAL.flw_attacker_state
					num_provinces = 2
					on_win = flw_clash.1
					on_lose = flw_clash.2
					on_cancel = flw_clash.3
				}

				defender = {
					state = var:GLOBAL.flw_defender_state
					num_provinces = 2
					on_win = flw_clash.4
					on_lose = flw_clash.5
					on_cancel = flw_clash.6
				}
			}
			hidden_effect = {
				set_border_war_data = {
					change_state_after_war = no
					attacker = var:GLOBAL.flw_attacker_state
					defender = var:GLOBAL.flw_defender_state
					attacker_modifier = 1.2
					defender_modifier = 0.8
					combat_width = 80
				}
			}
		}
		else_if = {
			limit = {
				tag = ITZ
			}
			start_border_war = {
				change_state_after_war = no # handled via event
				attacker = {
					state = var:GLOBAL.flw_attacker_state
					num_provinces = 2
					on_win = flw_clash.4
					on_lose = flw_clash.5
					on_cancel = flw_clash.6
				}

				defender = {
					state = var:GLOBAL.flw_defender_state
					num_provinces = 2
					on_win = flw_clash.1
					on_lose = flw_clash.2
					on_cancel = flw_clash.3
				}
			}
			hidden_effect = {
				set_border_war_data = {
					change_state_after_war = no
					attacker = var:GLOBAL.flw_attacker_state
					defender = var:GLOBAL.flw_defender_state
					attacker_modifier = 1.2
					defender_modifier = 0.8
					combat_width = 80
				}
			}
		}
		else_if = {
			log = "Neither ATE nor ITZ are attacker tag! Attacker tag is: [?GLOBAL.flw_attacker_tag] and defender tag is: [?GLOBAL.flw_defender_tag]"
		}
	}
}

hidden_flw_flip = {
	if = {
		limit = { NOT = { has_global_flag = first_flw_click } }
		set_global_flag = first_flw_click
	}
	else_if = {
		limit = { has_global_flag = first_flw_click }
		set_new_flw_target = yes
		clr_global_flag = first_flw_click
	}
}

adjust_flw_ideas = {
	if = {
		limit = {
			has_idea = flw_holds_la_tumba
			NOT = { owns_state = 817 }
		}
		swap_ideas = {
			add_idea = flw_not_holds_la_tumba
			remove_idea = flw_holds_la_tumba
		}
	}

	if = {
		limit = {
			has_idea = flw_not_holds_la_tumba
			owns_state = 817
		}
		swap_ideas = {
			add_idea = flw_holds_la_tumba
			remove_idea = flw_not_holds_la_tumba
		}
	}

	if = {
		limit = {
			has_idea = flw_holds_hela
			NOT = { owns_state = 815 }
		}
		swap_ideas = {
			add_idea = flw_not_holds_hela
			remove_idea = flw_holds_hela
		}
	}

	if = {
		limit = {
			has_idea = flw_not_holds_hela
			owns_state = 815
		}
		swap_ideas = {
			add_idea = flw_holds_hela
			remove_idea = flw_not_holds_hela
		}
	}

	if = {
		limit = {
			has_idea = flw_holds_mexico_city
			NOT = { owns_state = 803 }
		}
		swap_ideas = {
			add_idea = flw_not_holds_mexico_city
			remove_idea = flw_holds_mexico_city
		}
	}

	if = {
		limit = {
			has_idea = flw_not_holds_mexico_city
			owns_state = 803
		}
		swap_ideas = {
			add_idea = flw_holds_mexico_city
			remove_idea = flw_not_holds_mexico_city
		}
	}
}
